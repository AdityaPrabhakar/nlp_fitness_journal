<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Journal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        table {
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 6px 12px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>üìù Natural Language Fitness Journal</h1>

    <form method="POST">
        <textarea name="entry" rows="4" cols="50" placeholder="Describe your workout..."></textarea><br>
        <button type="submit">Log Workout</button>
    </form>

    <h2>üìÖ Logged Sessions</h2>
    <ul>
        {% for session in sessions %}
            <li>
                <strong>{{ session.date }}</strong>: {{ session.raw_text }}
                <ul>
                    {% for entry in session.entries %}
                        <li>
                            {{ entry.exercise }} ‚Äî
                            {% if entry.type == 'strength' %}
                                {{ entry.sets }}√ó{{ entry.reps }} reps
                                {% if entry.weight %} @ {{ entry.weight }} lbs{% endif %}
                            {% elif entry.type == 'cardio' %}
                                {% if entry.distance %}{{ entry.distance }} mi{% endif %}
                                {% if entry.duration %} ({{ entry.duration }} min){% endif %}
                            {% endif %}
                            {% if entry.notes %}
                                <br><em>üìù {{ entry.notes }}</em>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </li>
        {% endfor %}
    </ul>

    <h2>üìä Overall Cardio Progress</h2>
    <canvas id="cardioChart" height="100"></canvas>

    <h2>üìà View Cardio Progress by Exercise</h2>
    <select id="cardioSelect">
        <option disabled selected>Select cardio exercise</option>
        {% for exercise in cardio_exercises %}
            <option value="{{ exercise }}">{{ exercise }}</option>
        {% endfor %}
    </select>
    <canvas id="cardioExerciseChart" height="100"></canvas>

    <div id="cardioLogsContainer">
        <h3>üìÑ Cardio Log Entries</h3>
        <table id="cardioLogTable">
            <thead><tr><th>Date</th><th>Duration</th><th>Distance</th><th>Notes</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <h2>üí™ View Strength Progress by Exercise</h2>
    <select id="strengthSelect">
        <option disabled selected>Select strength exercise</option>
        {% for exercise in strength_exercises %}
            <option value="{{ exercise }}">{{ exercise }}</option>
        {% endfor %}
    </select>
    <canvas id="strengthExerciseChart" height="100"></canvas>

    <div id="strengthLogsContainer">
        <h3>üìÑ Strength Log Entries</h3>
        <table id="strengthLogTable">
            <thead><tr><th>Date</th><th>Sets</th><th>Reps</th><th>Weight</th><th>Notes</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
    function destroyChart(chart) {
        if (chart) chart.destroy();
    }

    async function loadCardioChart() {
        const res = await fetch("/api/progress/cardio");
        const data = await res.json();
        const ctx = document.getElementById('cardioChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [
                    {
                        label: 'Distance (mi)',
                        data: data.map(d => d.distance || 0),
                        borderColor: 'blue',
                        yAxisID: 'y1',
                        tension: 0.3
                    },
                    {
                        label: 'Duration (min)',
                        data: data.map(d => d.duration || 0),
                        borderColor: 'green',
                        yAxisID: 'y2',
                        tension: 0.3
                    }
                ]
            },
            options: {
                scales: {
                    y1: { type: 'linear', position: 'left' },
                    y2: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } }
                }
            }
        });
    }

    async function loadExerciseChart(type, exercise, canvasId) {
        const res = await fetch(`/api/progress/${type}/${exercise}`);
        const data = await res.json();
        const ctx = document.getElementById(canvasId).getContext('2d');

        if (window[canvasId + 'Chart']) {
            destroyChart(window[canvasId + 'Chart']);
        }

        const config = {
            type: type === 'cardio' ? 'line' : 'bar',
            data: {
                labels: data.map(d => d.date),
                datasets: type === 'cardio' ? [
                    {
                        label: 'Distance (mi)',
                        data: data.map(d => d.distance || 0),
                        borderColor: 'purple',
                        yAxisID: 'y1',
                        tension: 0.3
                    },
                    {
                        label: 'Duration (min)',
                        data: data.map(d => d.duration || 0),
                        borderColor: 'orange',
                        yAxisID: 'y2',
                        tension: 0.3
                    }
                ] : [
                    {
                        label: 'Volume (sets √ó reps)',
                        data: data.map(d => d.volume || 0),
                        backgroundColor: 'red',
                        yAxisID: 'y1',
                        barThickness: 20
                    },
                    {
                        label: 'Max Weight (lbs)',
                        data: data.map(d => d.max_weight || 0),
                        backgroundColor: 'blue',
                        yAxisID: 'y2',
                        barThickness: 20
                    }
                ]
            },
            options: {
                scales: {
                    y1: { type: 'linear', position: 'left' },
                    y2: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } }
                }
            }
        };

        window[canvasId + 'Chart'] = new Chart(ctx, config);
    }

    async function loadLogTable(type, exercise, tableId) {
        const res = await fetch(`/api/logs/${type}/${exercise}`);
        const data = await res.json();

        const table = document.getElementById(tableId);
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");

        if (type === 'cardio') {
            thead.innerHTML = "<tr><th>Date</th><th>Duration</th><th>Distance</th><th>Notes</th></tr>";
            tbody.innerHTML = data.map(entry =>
                `<tr>
                    <td>${entry.date}</td>
                    <td>${entry.duration ?? '-'}</td>
                    <td>${entry.distance ?? '-'}</td>
                    <td>${entry.notes ?? '-'}</td>
                </tr>`
            ).join("");
        } else {
            thead.innerHTML = "<tr><th>Date</th><th>Sets</th><th>Reps</th><th>Weight</th><th>Notes</th></tr>";
            tbody.innerHTML = data.map(entry =>
                `<tr>
                    <td>${entry.date}</td>
                    <td>${entry.sets ?? '-'}</td>
                    <td>${entry.reps ?? '-'}</td>
                    <td>${entry.weight ?? '-'}</td>
                    <td>${entry.notes ?? '-'}</td>
                </tr>`
            ).join("");
        }
    }

    document.getElementById("cardioSelect").addEventListener('change', function(event) {
        const exercise = event.target.value;
        loadExerciseChart('cardio', exercise, 'cardioExerciseChart');
        loadLogTable('cardio', exercise, 'cardioLogTable');
    });

    document.getElementById("strengthSelect").addEventListener('change', function(event) {
        const exercise = event.target.value;
        loadExerciseChart('strength', exercise, 'strengthExerciseChart');
        loadLogTable('strength', exercise, 'strengthLogTable');
    });

    loadCardioChart();
    </script>
</body>
</html>
